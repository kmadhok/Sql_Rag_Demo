<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Search Demo - Vector + AI SQL Generation</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .container { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        textarea { width: 100%; height: 60px; padding: 10px; font-size: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px 0; }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .result { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 20px; }
        pre { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .metrics { display: flex; gap: 20px; margin: 10px 0; flex-wrap: wrap; }
        .metric { background: #f3f4f6; padding: 8px 12px; border-radius: 4px; }
        .section { margin: 20px 0; }
        .section h4 { margin-bottom: 10px; }
        .document { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .doc-score { color: #64748b; font-size: 12px; }
        code { background: #f1f5f9; padding: 2px 4px; border-radius: 2px; }
        .error { color: #dc2626; background: #fef2f2; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { color: #10b981; }
    </style>
</head>
<body>
    <h1>‚ùì Query Search - Vector + AI SQL Generation</h1>
    <p><strong>This is the core functionality from your original Streamlit app!</strong></p>

    <div class="container">
        <h2>Ask a Question</h2>
        <textarea id="questionInput" placeholder="e.g., Show me the most expensive products OR Count users by gender OR Write SQL to join users and orders and compute monthly spend"></textarea>
        <button onclick="generateSQL()" id="generateBtn">Generate SQL with Gemini + Vector Search</button>
        <div id="loading" style="display: none;">üîÑ Generating SQL with vector search...</div>
    </div>

    <div id="results"></div>

    <script>
        async function generateSQL() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) {
                alert('Please enter a question');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            btn.disabled = true;
            loading.style.display = 'block';
            results.innerHTML = '';

            try {
                const response = await fetch('/api/query-search/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        k: 20,
                        use_gemini: true,
                        schema_injection: true,
                        sql_validation: true
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                displayResults(data);
                
            } catch (error) {
                results.innerHTML = `<div class="error"><strong>Error:</strong> ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }

        function displayResults(data) {
            const results = document.getElementById('results');
            let html = '<div class="result">';
            
            // Metrics
            html += '<div class="section"><h3>üìä Pipeline Metrics</h3>';
            html += '<div class="metrics">';
            html += `<div class="metric">Time: ${data.processing_time?.toFixed(2)}s</div>`;
            html += `<div class="metric">Documents: ${data.usage_stats?.documents_retrieved || 0}</div>`;
            html += `<div class="metric">Tables: ${data.usage_stats?.tables_retrieved || 0}</div>`;
            html += `<div class="metric ${data.validation_passed ? 'success' : ''}">Validation: ${data.validation_passed ? '‚úÖ PASSED' : '‚ùå FAILED'}</div>`;
            html += '</div></div>';

            // Retrieved Documents
            if (data.retrieved_documents?.length > 0) {
                html += '<div class="section"><h3>üìö Retrieved Similar Queries</h3>';
                data.retrieved_documents.forEach(doc => {
                    html += `<div class="document">`;
                    html += `<div class="doc-score">Score: ${doc.metadata?.score || 'N/A'}</div>`;
                    html += `<code>${doc.content.substring(0, 200)}${doc.content.length > 200 ? '...' : ''}</code>`;
                    if (doc.metadata?.description) html += `<div>${doc.metadata.description}</div>`;
                    html += `</div>`;
                });
                html += '</div>';
            }

            // Schema
            if (data.schema_injected) {
                html += '<div class="section"><h3>üèóÔ∏è Injected Schema</h3>';
                html += `<pre>${data.schema_injected.substring(0, 500)}${data.schema_injected.length > 500 ? '\\n... (truncated)' : ''}</pre>`;
                html += '</div>';
            }

            // SQL Result
            if (data.sql_query) {
                html += '<div class="section"><h3>üîß Generated SQL</h3>';
                html += `<button onclick="copySQL('${btoa(data.sql_query)}')">üìã Copy SQL</button>`;
                html += `<pre>${data.sql_query}</pre>`;
                if (data.validation_errors?.length > 0) {
                    html += '<div class="error"><h4>‚ö†Ô∏è Validation Errors:</h4><ul>';
                    data.validation_errors.forEach(err => html += `<li>${err}</li>`);
                    html += '</ul></div>';
                }
                html += '</div>';
            }

            html += '</div>';
            results.innerHTML = html;
        }

        function copySQL(base64SQL) {
            const sql = atob(base64SQL);
            navigator.clipboard.writeText(sql).then(() => {
                alert('SQL copied to clipboard!');
            }).catch(() => {
                prompt('Copy this SQL:', sql);
            });
        }

        // Add example questions
        document.addEventListener('DOMContentLoaded', () => {
            const examples = [
                "Show me the most expensive products",
                "Count users by gender", 
                "Find customers with the most orders",
                "Write SQL to join users and orders and compute monthly spend"
            ];
            
            const input = document.getElementById('questionInput');
            let exampleIndex = 0;
            
            input.addEventListener('focus', () => {
                if (!input.value) {
                    input.placeholder = examples[exampleIndex % examples.length];
                    exampleIndex++;
                }
            });
        });
    </script>
</body>
</html>
